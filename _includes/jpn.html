{%- assign jpn = include.jpn | split: "|" %}{% assign furi = include.furi | split: "|" %}{% if jpn == furi -%}
<span class="jpn{% if include.class %} {{ include.class }}{% endif %}">{{ jpn | join: "" | replace: " ", "&#32;" | replace: "　", "&#x3000;" }}<span class="romaji">{{ include.rom }}</span></span>{%- elsif jpn.size == furi.size -%}
<ruby class="jpn{% if include.class %} {{ include.class }}{% endif %}" alt="{{ jpn | join: "" }}">{% for group in jpn %}{% if furi[forloop.index0] == " " %}&ensp;{% else %}{{ jpn[forloop.index0] | replace: " ", "&#32;" | replace: "　", "&#x3000;" }}{% endif %}<rp>(</rp><rt class="{% if jpn[forloop.index0] == furi[forloop.index0] %}kana{% else %}furi{% endif %}">{{ furi[forloop.index0] | replace: " ", "&#32;" | replace: "　", "&#x3000;" }}</rt><rp>)</rp>{% endfor %}<span class="romaji">{{ include.rom }}</span></ruby>{%- else -%}
<span class="jpn{% if include.class %} {{ include.class }}{% endif %}">{{ jpn | join: "" }}<span class="romaji">{{ include.rom }}</span></span>{%- endif -%}